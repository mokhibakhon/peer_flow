{% extends "base.html" %}

{% block title %}Dashboard - Peer Flow{% endblock %}

{% block head %}
<script>
    // Store completed challenges in localStorage
    let completed = {{ completed | tojson }};
    const STORAGE_KEY = 'peerflow_completed';
    
    // Load completed challenges from localStorage on page load
    document.addEventListener('DOMContentLoaded', function() {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
            try {
                completed = JSON.parse(stored);
            } catch {
                localStorage.removeItem(STORAGE_KEY);
            }
        }
        loadChallengeData();
    });
    
    async function loadChallengeData() {
        try {
            const response = await fetch('/api/challenge', { method: 'POST' });
            const data = await response.json();
            renderChallenge(data.plan);
        } catch (error) {
            console.error('Failed to load challenge:', error);
            document.getElementById('loading').innerHTML = '<p class="p-6 text-red-600">Failed to load your challenge.</p>';
        }
    }
    
    function renderChallenge(plan) {
        const loadingEl = document.getElementById('loading');
        if (!plan || plan.length === 0) {
            loadingEl.innerHTML = '<p class="p-6 text-red-600">Failed to load your challenge.</p>';
            return;
        }
        
        const streak = plan.filter(d => completed[d.day]).length;
        const weeks = [0, 1, 2].map(i => plan.slice(i * 7, i * 7 + 7));
        
        // Update progress bar
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const progressPercent = (streak / 21) * 100;
        
        progressBar.style.width = `${progressPercent}%`;
        progressText.textContent = `${streak}/21`;
        
        // Render weeks
        const weeksContainer = document.getElementById('weeks-container');
        weeksContainer.innerHTML = weeks.map((week, weekIndex) => `
            <div class="space-y-4">
                <h3 class="text-lg font-semibold">Week ${weekIndex + 1}</h3>
                <div class="grid gap-3">
                    ${week.map(day => `
                        <div class="flex items-center gap-3 p-4 bg-white rounded-lg border ${completed[day.day] ? 'border-accent bg-accent/5' : 'border-gray-200'}">
                            <button 
                                onclick="toggleDay(${day.day})"
                                class="w-6 h-6 rounded-full border-2 flex items-center justify-center ${completed[day.day] ? 'bg-accent border-accent' : 'border-gray-300'}">
                                ${completed[day.day] ? 
                                    '<svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>' : 
                                    ''
                                }
                            </button>
                            <div class="flex-1">
                                <h4 class="font-medium">${day.title}</h4>
                                <p class="text-sm text-gray-500">${day.description}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');
        
        loadingEl.style.display = 'none';
        document.getElementById('dashboard-content').style.display = 'block';
    }
    
    function toggleDay(day) {
        completed[day] = !completed[day];
        localStorage.setItem(STORAGE_KEY, JSON.stringify(completed));
        loadChallengeData(); // Re-render to update UI
    }
    
    async function saveProgress() {
        try {
            await fetch('/api/save-progress', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ completed })
            });
            alert('Your progress has been saved!');
        } catch (error) {
            console.error('Failed to save progress:', error);
            alert('Failed to save progress. Please try again.');
        }
    }
</script>
{% endblock %}

{% block content %}
<div class="container mx-auto px-6 py-10">
    <!-- Header -->
    <header class="mb-8 flex flex-col sm:flex-row items-center justify-between gap-4">
        <h1 class="text-3xl font-bold">21-Day Challenge</h1>
        <div class="flex items-center gap-4">
            <span class="text-sm">
                Partner: <strong>{{ partner }}</strong>
            </span>
            <a href="{{ url_for('find_a_peer') }}" class="text-accent hover:underline text-sm">
                Change
            </a>
        </div>
    </header>

    <!-- Progress bar -->
    <div class="mb-6">
        <div class="flex items-center justify-between mb-2">
            <span class="font-medium">Progress</span>
            <span class="font-semibold text-accent" id="progress-text">0/21</span>
        </div>
        <div class="w-full bg-gray-200 h-3 rounded-full overflow-hidden">
            <div id="progress-bar" class="bg-accent h-3 transition-all duration-300" style="width: 0%"></div>
        </div>
    </div>

    <!-- Action buttons -->
    <div class="mb-8 flex flex-col sm:flex-row gap-4">
        <a href="{{ url_for('room', room_slug=room_slug) }}" 
           class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-primary hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
            Join Study Room
        </a>
        
        <button onclick="saveProgress()" 
                class="inline-flex items-center justify-center px-6 py-3 border border-gray-300 text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
            </svg>
            Save Progress
        </button>
    </div>

    <!-- Loading state -->
    <div id="loading">
        <p class="p-6 text-gray-500">Loading your 21-day planâ€¦</p>
    </div>

    <!-- Dashboard content -->
    <div id="dashboard-content" style="display: none;">
        <div class="space-y-12" id="weeks-container">
            <!-- Weeks will be rendered here by JavaScript -->
        </div>
    </div>
</div>
{% endblock %} 